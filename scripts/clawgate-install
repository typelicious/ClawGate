#!/usr/bin/env bash
set -euo pipefail

repo_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
helpers=(
  clawgate-install
  clawgate-start
  clawgate-stop
  clawgate-restart
  clawgate-status
  clawgate-logs
  clawgate-health
  clawgate-update
  clawgate-uninstall
)

if ! id -u clawgate >/dev/null 2>&1; then
  sudo useradd --system --home /opt/clawgate --shell /usr/sbin/nologin clawgate
fi

sudo install -d -o clawgate -g clawgate -m 755 /var/lib/clawgate
sudo install -m 644 "$repo_root/clawgate.service" /etc/systemd/system/clawgate.service

for helper in "${helpers[@]}"; do
  sudo ln -sf "$repo_root/scripts/$helper" "/usr/local/bin/$helper"
done

sudo systemctl daemon-reload
sudo systemctl enable --now clawgate.service
sudo systemctl status clawgate.service --no-pager -l | sed -n "1,120p"
