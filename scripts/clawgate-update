#!/usr/bin/env bash
set -euo pipefail

# update code from repo + restart service
cd /opt/clawgate
git fetch --all --prune
git reset --hard origin/main
git clean -fd

# venv deps optional (nur wenn requirements / pyproject changed)
if [ -f venv/bin/pip ]; then
  venv/bin/pip install -U pip >/dev/null
  if [ -f requirements.txt ]; then
    venv/bin/pip install -r requirements.txt
  fi
fi

sudo install -m 644 clawgate.service /etc/systemd/system/clawgate.service
sudo systemctl daemon-reload
sudo systemctl restart clawgate.service

for attempt in 1 2 3 4 5; do
  if ./scripts/clawgate-health; then
    exit 0
  fi
  sleep 2
done

echo "health check failed after 5 attempts" >&2
exit 1
